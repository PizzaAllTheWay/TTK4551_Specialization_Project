\subsection{Cartesian Mapping}
\subsubsection{Cartesian Map}
After swath processing, each sonar ping has been geometrically corrected, radiometrically normalized, and reconstructed into a consistent 2D representation of seabed reflectivity in horizontal ground coordinates. The Cartesian mapping stage takes these processed swaths and projects them into a unified local map in world coordinates. Each swath is positioned according to the vehicles estimated pose, producing a spatially consistent intensity image of the surrounding seafloor.  
\\ \\
This step converts the sonar data from its native beam geometry into a uniform Cartesian grid where both axes correspond to real world ground distances. The resulting map represents the local seabed reflectivity distribution and serves as the primary input for subsequent feature extraction and SLAM integration.



\subsubsection{Projection from Polar to Cartesian}
The projection from polar to Cartesian coordinates converts each processed swath from range geometry into world referenced ground coordinates using the estimated vessel pose. After slant range correction, every sonar sample represents a point on the seafloor at a known horizontal ground range $r_g$ from the transducer. Each ping line corresponds to one along track position determined by the vehicles estimated trajectory, while the across track coordinate is given by the ground projected range $r_g$ on either the port or starboard side.  
\\ \\
Given the vehicle position $\mathbf{p}_{b/O}^{n}$ and attitude quaternion $\mathbf{q}$ from the navigation state in Equation \ref{eq:kinematics-motion-model-states}, each sonar sample is transformed from the sonar frame to the NED frame through a complete frame chain. The sonar is rigidly mounted to the vessel body with a fixed lever arm offset 
$$
    \mathbf{r}_{s/b}^{b} =
    \begin{bmatrix}
        x_{s/b}^{b} \\ y_{s/b}^{b} \\ z_{s/b}^{b}
    \end{bmatrix}
$$
and orientation $R_s^b$, which defines the fixed rotation from the sonar to the vessel body frame. The matrix $R_s^b$ is determined by the sonar mounting configuration and differs between the port and starboard transducers depending on their orientation relative to the vessels longitudinal axis. Typically, the mounting angles include a fixed yaw offset of $\pm 90^\circ$ for port and starboard, a pitch offset equal to the sonar depression angle $\beta$, and negligible roll offset assuming level installation. The vessel body pose in the global NED frame is given by the position $\mathbf{p}_{b/O}^{n}$ and rotation matrix $R_b^n(\mathbf{q})$, derived from the navigation state quaternion $\mathbf{q}$.
\\ \\
Each sonar intensity sample after slant range correction represents a seafloor point in the sonar frame, expressed as
$$
    \mathbf{p}_{g/s}^{s} =
    \begin{bmatrix}
        \pm r_g \\ 0 \\ 0
    \end{bmatrix}
$$
where $r_g$ is the ground projected range computed from the corrected slant range (see Equation \ref{eq:local-map-generation-ground-range-projection}), and the sign $\pm$ indicates the sonar channel, negative for port and positive for starboard. The notation $\mathbf{p}_{g/s}^{s}$ denotes the position of the ground point $g$ relative to the sonar origin $s$, expressed in the sonar coordinate frame.
\\ \\
The corresponding global position of this seafloor point in the NED frame is then computed as
$$
    \mathbf{p}_{g/O}^{n} =
    R_b^n(\mathbf{q}) \left( R_s^b \mathbf{p}_{g/s}^{s} + \mathbf{r}_{s/b}^{b} \right)
    + \mathbf{p}_{b/O}^{n}
$$
Using simple kinematic relations, one can derive this transformation to project each ground point from the sonar frame into global NED coordinates.



\subsubsection{kNN Interpolation and Grid Reconstruction}
Once all sonar samples have been transformed into global coordinates, they are used to populate a local Cartesian grid representing the current seafloor patch. Because the sonar returns are distributed irregularly along the track, many grid cells may not contain direct measurements. To obtain a dense and spatially continuous reflectivity map, a k-Nearest Neighbor (kNN) interpolation approach is applied, the same method described in \cite{side_scan_sonar_master_thesis}.  
\\ \\
A KD-tree is constructed from all transformed sonar sample positions $\mathbf{p}_{g/O}^{n}$ to enable efficient nearest neighbor searches. For each grid cell centered at $(x_i, y_j)$, the $k$ closest sonar samples within a maximum search radius $r_{max}$ are retrieved from the KD-tree. The distance between the grid cell center and each neighbor is computed as
$$
    d_k = \left\| 
    \mathbf{p}_{g/O}^{n}(k) -
    \begin{bmatrix} x_i \\ y_j \\ 0 \end{bmatrix}
    \right\|
$$
where $\mathbf{p}_{g/O}^{n}(k)$ denotes the NED position of the $k$-th sonar sample.  
\\ \\
Each neighbor contributes to the grid cell reflectivity based on its proximity, using an inverse distance weighting function:
$$
    w_k = \frac{1}{((d_k)^p + \epsilon)}
$$
where $p$ controls how strongly distance affects the weight (typically $1 \leq p \leq 2$), and $\epsilon$ is a small constant preventing division by zero. Higher $p$ values make the weighting sharper, giving greater emphasis to nearby points.  
\\ \\
The final normalized reflectivity assigned to each grid cell is computed as the weighted mean of its $k$ nearest sonar samples:
\begin{equation}
    \hat{R}(x_i, y_j) =
    \frac{\sum_{k=1}^{K} w_k \, \hat{R}(k)}
         {\sum_{k=1}^{K} w_k}
    \label{eq:cartesian-mapping-knn}
\end{equation}
where $\hat{R}(k)$ is the normalized backscatter intensity of the $k$-th sonar sample obtained from the reflectivity normalization step (see Equation \ref{eq:local-map-generation-reflectivity-normalization}).  
\\ \\
Grid cells with no valid neighbors within $r_{max}$ remain empty or can optionally be filled by extrapolation from surrounding cells. Outlier rejection may also be applied by discarding neighbors with abnormally large distances or high local variance.  
\\ \\
This kNN based interpolation ensures smooth spatial transitions and continuous coverage even in sparsely sampled regions. It effectively balances computational efficiency with mapping accuracy, providing a dense local reflectivity map suitable for both real-time operation and offline refinement.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Pictures/Local_Map_Generation/Cartesian_Mapping/2D_KD_tree.png}
    \caption{Illustration of a 2D KD-tree used for k-Nearest Neighbor search. (a) shows the spatial partitioning of sample points in the $(x,y)$ plane, and (b) shows the corresponding binary tree structure where each node alternates between splitting along the $x$ and $y$ axes. This hierarchical structure enables efficient $k$-nearest neighbor queries for interpolating sonar samples in the Cartesian grid.\textsuperscript{\cite{kd_tree}}}
    \label{fig:local-map-generation-2d-kd-tree}
\end{figure}



\subsubsection{Sliding Map Window and Overlap}
The local Cartesian map represents a continuously updated snippet of the seafloor constructed from the most recent $N$ processed swath samples. Initially, $N$ samples are collected and transformed into Cartesian coordinates to form the first local map.  
\\ \\
At each update, 2/3rds of the oldest samples are discarded, while 1/3rd are retained to preserve spatial overlap between consecutive maps. The remaining 2/3rds of the map are filled with newly processed data and reprojected through the kNN interpolation stage, ensuring smooth transitions and temporal continuity between frames. This approach provides sufficient redundancy for cross correlation and landmark consistency during feature extraction.  
\\ \\
The choice of $N$ is an important design parameter affecting both temporal resolution and mapping accuracy. If $N$ is too large, map updates occur too slowly, allowing uncertainty in landmark positions to grow as the SLAM covariance increases between updates. Conversely, if $N$ is too small, the map may contain too few features for reliable data association. It is generally better to select $N$ slightly larger rather than smaller, ensuring adequate feature visibility at the cost of minor latency. In practice, $N$ is tuned empirically based on vehicle speed, ping rate, and sonar range, typically ranging from several hundred to a few thousand processed swaths samples.  
\\ \\
In implementation, the sliding window can be efficiently managed using a \textit{``ring buffer''} data structure, which continuously overwrites the oldest entries with new incoming samples. This enables constant time insertion and removal operations, maintaining a fixed memory footprint and real-time performance even during long duration missions.  
\\ \\
At this stage, the local Cartesian map only contains the most recent $N$ swath samples and is limited in spatial extent to support real-time operation. During SLAM based global reconstruction, successive local maps are aligned and stitched together using the estimated trajectory to form a unified global seafloor mosaic encompassing all collected data. The details of this global reconstruction process are discussed later in the \textit{``Global Map and Trajectory''} chapter.  
\\ \\
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Pictures/Local_Map_Generation/Cartesian_Mapping/Sliding_Map_Window.png}
    \caption{Illustration of the sliding map window mechanism. Each frame represents a local Cartesian map constructed from $N$ swath samples. As new data arrives, the window advances, retaining 1/3rd of the previous samples for overlap while discarding older data, to maintain continuity and ensure a real-time, memory efficient mapping process.}
    \label{fig:local-map-generation-sliding-map-window}
\end{figure}
